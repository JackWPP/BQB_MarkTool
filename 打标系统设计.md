# 北化图库智能打标系统 - 开发文档 (BUCT Tagger)

## 1. 系统定位

这是一个 **离线桌面端工具 (.exe)** ，用于在图片正式入库前，构建“人机回圈 (Human-in-the-Loop)”的数据生产管线。

* **输入** : 原始图片文件夹。
* **辅助** : VLM (视觉大模型) 预生成标签。
* **人工** : 校对、修正、补充北化特色标签。
* **输出** : 清洗好的 JSON 数据 + 生成好的缩略图 -> 导入主平台数据库。

## 2. 核心工作流 (Workflow)

**代码段s**

```
graph LR
    A[原始素材库] --> B(Python脚本: 预处理);
    B -->|1. 提取EXIF<br>2. 调用VLM API| C[预标注 JSON];
    C --> D(人工打标客户端 .exe);
    D -->|人工校对 & 缩略图生成| E[最终入库包];
    E -->|导入| F[(线上数据库)];
```

## 3. 模块开发规范

### 3.1 预处理模块 (Python Script)

* **功能** : 遍历文件夹，为每张图生成 UUID，读取 EXIF 时间，调用 API 生成初步描述。
* **VLM Prompt 设计** :

> "请分析这张图片。
>
> 1. 判断季节 (Spring/Summer/Autumn/Winter)。
> 2. 判断场景类型 (Landscape/Portrait/Activity/Documentary)。
> 3. 提取画面中的关键物体 (不超过5个)。
>    以JSON格式返回。"

### 3.2 客户端 GUI (PyQt6 / PySide6)

这是分发给同学使用的软件。

 **界面布局定义** :

* **左侧 (70%)** : 图片预览区。支持滚轮缩放，支持左右键切换图片。
* **右侧 (30%)** : 操作面板。
* **信息栏** : 显示 UUID、拍摄日期。
* **快捷属性 (Radio Buttons)** :
  * *校区* : [东区] [北区] [西区] [未知]
  * *季节* : [春] [夏] [秋] [冬] (默认选中 VLM 的判断结果)
* **快速标签 (Toggle Buttons)** :
  * 预设北化高频词：`母校之光` `图书馆` `第一教学楼` `行政楼` `樱花` `银杏` `军训` `毕业`。
  * 点击即变色（选中），再次点击取消。
* **关键词输入框** : 显示 VLM 识别的物体，允许人工增删。
* **保存按钮** : "保存并下一张 (Ctrl+S)"。

### 3.3 数据交换协议 (JSON Schema)

这是工具导出、主平台导入的标准格式。

**JSON**

```
[
  {
    "uuid": "550e8400-e29b-41d4-a716-446655440000",
    "filename": "DSC001.jpg",
    "processed_path": "./2025/10/550e...jpg",  // 工具生成的规范文件名
    "thumb_path": "./thumb/550e..._thumb.jpg", // 工具生成的缩略图
    "width": 6000,
    "height": 4000,
    "tags": {
      "attributes": {
        "campus": "北校区",
        "season": "秋季",
        "category": "校园风光"
      },
      "keywords": ["银杏", "落叶", "阳光", "道路"],
      "meta": {
        "vlm_description": "一条铺满金色落叶的道路...",
        "annotator": "User_01" // 标记是谁打的标
      }
    }
  }
]
```

## 4. 开发路线图 (Roadmap)

### 第一阶段：脚本与基建 (你来完成)

1. 写好 `pre_process.py`: 完成 UUID 生成、EXIF 读取、VLM API 调通。
2. 搭建好 PostgreSQL 数据库，建好表。

### 第二阶段：GUI工具开发 (你来完成)

1. 使用 Python + PyQt6 搭建界面框架。
2. 实现读取 `pre_process.py` 生成的 JSON 并显示图片。
3. 实现点击按钮修改 JSON 数据。
4. 实现“保存”逻辑：更新 JSON，利用 Pillow 库生成缩略图。
5. 使用 `PyInstaller` 打包成 `.exe`。

### 第三阶段：分发与入库

1. 将图片文件夹 + `.exe` 发给同学。
2. 回收结果文件夹。
3. 编写 `import_db.py`: 读取最终 JSON，将数据写入 Postgres，将文件移动到 MinIO 目录。

### 附录

使用的VLM：qwen3-vl-flash

API key: sk-dd280b67097548a8ab1b1ccd9b767569

不需要调用思考 在调用的过程中最好能够进行一些本地的图片压缩 减少token使用量

API示例：

```python
import os
import dashscope
from dashscope import MultiModalConversation
# dashscope.base_http_api_url = "https://dashscope.aliyuncs.com/api/v1"

messages = [
    {
        "role": "user",
        "content": [
            {"image": "https://img.alicdn.com/imgextra/i1/O1CN01gDEY8M1W114Hi3XcN_!!6000000002727-0-tps-1024-406.jpg"},
            {"text": "解答这道题？"}
        ]
    }
]

response = MultiModalConversation.call(
    # 若没有配置环境变量，请用百炼API Key将下行替换为：api_key="sk-xxx",
    api_key=os.getenv('DASHSCOPE_API_KEY'),
    model="qwen3-vl-flash",
    messages=messages,
    stream=True,
    # enable_thinking 参数开启思考过程
    enable_thinking=True,
    # thinking_budget 参数设置最大推理过程 Token 数
    thinking_budget=81920,

)

# 定义完整思考过程
reasoning_content = ""
# 定义完整回复
answer_content = ""
# 判断是否结束思考过程并开始回复
is_answering = False

print("=" * 20 + "思考过程" + "=" * 20)

for chunk in response:
    # 如果思考过程与回复皆为空，则忽略
    message = chunk.output.choices[0].message
    reasoning_content_chunk = message.get("reasoning_content", None)
    if (chunk.output.choices[0].message.content == [] and
        reasoning_content_chunk == ""):
        pass
    else:
        # 如果当前为思考过程
        if reasoning_content_chunk != None and chunk.output.choices[0].message.content == []:
            print(chunk.output.choices[0].message.reasoning_content, end="")
            reasoning_content += chunk.output.choices[0].message.reasoning_content
        # 如果当前为回复
        elif chunk.output.choices[0].message.content != []:
            if not is_answering:
                print("\n" + "=" * 20 + "完整回复" + "=" * 20)
                is_answering = True
            print(chunk.output.choices[0].message.content[0]["text"], end="")
            answer_content += chunk.output.choices[0].message.content[0]["text"]

# 如果您需要打印完整思考过程与完整回复，请将以下代码解除注释后运行
# print("=" * 20 + "完整思考过程" + "=" * 20 + "\n")
# print(f"{reasoning_content}")
# print("=" * 20 + "完整回复" + "=" * 20 + "\n")
# print(f"{answer_content}")
```
